{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Orchid",
  "scopeName": "source.orchid",
  "fileTypes": ["orch"],
  "patterns": [
    { "include": "#comment" },
    { "include": "#docstring" },
    { "include": "#atomic-block" },
    { "include": "#directive" },
    { "include": "#agent-definition" },
    { "include": "#macro-definition" },
    { "include": "#tag-block" },
    { "include": "#string" },
    { "include": "#number" },
    { "include": "#operator" },
    { "include": "#namespace-call" },
    { "include": "#reasoning-macro" },
    { "include": "#meta-operation" },
    { "include": "#builtin-function" },
    { "include": "#keyword" },
    { "include": "#constant" },
    { "include": "#variable-interpolation" },
    { "include": "#implicit-context" }
  ],
  "repository": {
    "comment": {
      "patterns": [
        {
          "name": "comment.line.section.orchid",
          "match": "^\\s*(##)\\s+(.*)$",
          "captures": {
            "1": { "name": "punctuation.definition.comment.orchid" },
            "2": { "name": "markup.heading.orchid" }
          }
        },
        {
          "name": "comment.line.number-sign.orchid",
          "match": "#.*$",
          "captures": {
            "0": { "name": "comment.line.number-sign.orchid" }
          }
        }
      ]
    },
    "docstring": {
      "name": "string.quoted.triple.orchid",
      "begin": "\"\"\"",
      "end": "\"\"\"",
      "beginCaptures": { "0": { "name": "punctuation.definition.string.begin.orchid" } },
      "endCaptures": { "0": { "name": "punctuation.definition.string.end.orchid" } }
    },
    "atomic-block": {
      "name": "keyword.control.atomic.orchid",
      "match": "^\\s*###\\s*$"
    },
    "directive": {
      "patterns": [
        {
          "match": "^(@(?:orchid|name|author|description|requires))\\b(.*)",
          "captures": {
            "1": { "name": "keyword.other.directive.orchid" },
            "2": {
              "patterns": [
                { "include": "#string" },
                { "include": "#namespace-call" },
                {
                  "name": "entity.name.function.orchid",
                  "match": "\\b(?:MCP|Plugin)\\b"
                }
              ]
            }
          }
        }
      ]
    },
    "agent-definition": {
      "match": "\\b(agent)\\s+([A-Z]\\w*)",
      "captures": {
        "1": { "name": "keyword.declaration.agent.orchid" },
        "2": { "name": "entity.name.type.agent.orchid" }
      }
    },
    "macro-definition": {
      "match": "\\b(macro)\\s+([A-Z]\\w*)",
      "captures": {
        "1": { "name": "keyword.declaration.macro.orchid" },
        "2": { "name": "entity.name.function.macro.orchid" }
      }
    },
    "tag-block": {
      "begin": "(?<=\\))<|(?<=[a-zA-Z_])<",
      "end": ">",
      "beginCaptures": { "0": { "name": "punctuation.definition.tag.begin.orchid" } },
      "endCaptures": { "0": { "name": "punctuation.definition.tag.end.orchid" } },
      "name": "meta.tag.orchid",
      "patterns": [
        {
          "name": "entity.other.attribute-name.orchid",
          "match": "\\b(?:deep|quick|urgent|best_effort|strict|tentative|retry|backoff|timeout|cached|fallback|pure|private|silent|verbose|raw|cite|append|isolated|frozen)\\b"
        },
        {
          "name": "variable.other.dynamic-tag.orchid",
          "match": "\\$\\w+"
        },
        {
          "include": "#number"
        },
        {
          "name": "keyword.operator.assignment.orchid",
          "match": "="
        },
        {
          "name": "punctuation.separator.comma.orchid",
          "match": ","
        }
      ]
    },
    "string": {
      "name": "string.quoted.double.orchid",
      "begin": "\"",
      "end": "\"",
      "beginCaptures": { "0": { "name": "punctuation.definition.string.begin.orchid" } },
      "endCaptures": { "0": { "name": "punctuation.definition.string.end.orchid" } },
      "patterns": [
        {
          "name": "constant.character.escape.orchid",
          "match": "\\\\[\"\\\\n\\t]"
        },
        {
          "name": "variable.other.interpolated.orchid",
          "match": "\\$\\{[^}]+\\}"
        },
        {
          "name": "variable.other.interpolated.orchid",
          "match": "\\$[a-zA-Z_]\\w*"
        }
      ]
    },
    "number": {
      "patterns": [
        {
          "name": "constant.numeric.float.orchid",
          "match": "\\b\\d+\\.\\d+\\b"
        },
        {
          "name": "constant.numeric.integer.orchid",
          "match": "\\b\\d+(?:s|ms)?\\b"
        }
      ]
    },
    "operator": {
      "patterns": [
        {
          "name": "keyword.operator.assignment.walrus.orchid",
          "match": ":="
        },
        {
          "name": "keyword.operator.append.orchid",
          "match": "\\+="
        },
        {
          "name": "keyword.operator.pipe.orchid",
          "match": ">>"
        },
        {
          "name": "keyword.operator.comparison.orchid",
          "match": "==|!=|>=|<="
        },
        {
          "name": "keyword.operator.arithmetic.orchid",
          "match": "[+\\-*/]"
        },
        {
          "name": "keyword.operator.comparison.orchid",
          "match": "[><]"
        }
      ]
    },
    "namespace-call": {
      "match": "\\b([a-zA-Z_]\\w*)(:)([a-zA-Z_]\\w*)",
      "captures": {
        "1": { "name": "entity.name.namespace.orchid" },
        "2": { "name": "punctuation.separator.namespace.orchid" },
        "3": { "name": "entity.name.function.tool.orchid" }
      }
    },
    "reasoning-macro": {
      "match": "\\b(CoT|CoVe|Decompose|Classify|Extract|Compare|Timeline|Spatial|Quantify|Critique|RedTeam|Steelman|DevilsAdvocate|Counterfactual|Validate|Refine|Consensus|Debate|Synthesize|Reconcile|Prioritize|ELI5|Formal|Analogize|Socratic|Narrate|Translate|Creative|Brainstorm|Abstract|Ground|Reframe|Generate|Search|Summarize)\\b",
      "name": "support.function.reasoning-macro.orchid"
    },
    "meta-operation": {
      "match": "\\b(Confidence|Explain|Reflect|Trace|Checkpoint|Rollback|Benchmark|Elapsed|Cost|Save)\\b",
      "name": "support.function.meta.orchid"
    },
    "builtin-function": {
      "match": "\\b(Log|Error|len|Discover)\\b",
      "name": "support.function.builtin.orchid"
    },
    "keyword": {
      "patterns": [
        {
          "name": "keyword.control.flow.orchid",
          "match": "\\b(if|elif|else|for|in|while|until|try|except|finally|return|break)\\b"
        },
        {
          "name": "keyword.control.fork.orchid",
          "match": "\\b(fork)\\b"
        },
        {
          "name": "keyword.declaration.orchid",
          "match": "\\b(agent|macro)\\b"
        },
        {
          "name": "keyword.control.event.orchid",
          "match": "\\b(emit|on|listen|Stream)\\b"
        },
        {
          "name": "keyword.control.guard.orchid",
          "match": "\\b(assert|require)\\b"
        },
        {
          "name": "keyword.operator.logical.orchid",
          "match": "\\b(and|or|not)\\b"
        },
        {
          "name": "keyword.other.import.orchid",
          "match": "\\b(import|as|Use|MCP|Plugin|permissions)\\b"
        }
      ]
    },
    "constant": {
      "patterns": [
        {
          "name": "constant.language.boolean.orchid",
          "match": "\\b(true|false)\\b"
        },
        {
          "name": "constant.language.null.orchid",
          "match": "\\b(null)\\b"
        }
      ]
    },
    "variable-interpolation": {
      "name": "variable.other.interpolated.orchid",
      "match": "\\$[a-zA-Z_]\\w*"
    },
    "implicit-context": {
      "name": "variable.language.implicit.orchid",
      "match": "\\b_\\b"
    }
  }
}
